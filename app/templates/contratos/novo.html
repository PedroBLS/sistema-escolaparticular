{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="fas fa-file-contract text-primary me-2"></i>
                    Novo Contrato
                </h2>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-secondary" onclick="limparFormulario()">
                        <i class="fas fa-eraser me-2"></i>
                        Limpar
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="buscarResponsavelExistente()">
                        <i class="fas fa-search me-2"></i>
                        Buscar Responsável
                    </button>
                </div>
            </div>

            <form id="form-novo-contrato" method="POST" action="/contratos/novo">
                <div class="row">
                    <!-- Coluna Esquerda - Dados do Responsável -->
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-user-tie me-2"></i>
                                    Dados do Responsável
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="responsavel_select" class="form-label">Responsável Existente</label>
                                    <select class="form-select" id="responsavel_select" name="responsavel_id">
                                        <option value="0">Selecione um responsável existente ou cadastre novo</option>
                                        {% for responsavel in responsaveis %}
                                        <option value="{{ responsavel.id }}" 
                                                data-nome="{{ responsavel.nome }}"
                                                data-cpf="{{ responsavel.cpf }}"
                                                data-rg="{{ responsavel.rg }}"
                                                data-telefone="{{ responsavel.telefone }}"
                                                data-email="{{ responsavel.email }}"
                                                data-endereco="{{ responsavel.endereco }}"
                                                data-estado-civil="{{ responsavel.estado_civil }}"
                                                data-nacionalidade="{{ responsavel.nacionalidade }}">
                                            {{ responsavel.nome }} - {{ responsavel.cpf }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="responsavel_nome" class="form-label">Nome Completo *</label>
                                    <input type="text" class="form-control" id="responsavel_nome" name="responsavel_nome" required>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="responsavel_cpf" class="form-label">CPF *</label>
                                            <input type="text" class="form-control" id="responsavel_cpf" name="responsavel_cpf" 
                                                   placeholder="000.000.000-00" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="responsavel_rg" class="form-label">RG *</label>
                                            <input type="text" class="form-control" id="responsavel_rg" name="responsavel_rg" required>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="responsavel_telefone" class="form-label">Telefone *</label>
                                            <input type="text" class="form-control" id="responsavel_telefone" name="responsavel_telefone" 
                                                   placeholder="(61) 99999-9999" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="responsavel_email" class="form-label">E-mail *</label>
                                            <input type="email" class="form-control" id="responsavel_email" name="responsavel_email" required>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="responsavel_endereco" class="form-label">Endereço Completo *</label>
                                    <textarea class="form-control" id="responsavel_endereco" name="responsavel_endereco" 
                                              rows="2" required></textarea>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="responsavel_estado_civil" class="form-label">Estado Civil</label>
                                            <select class="form-select" id="responsavel_estado_civil" name="responsavel_estado_civil">
                                                <option value="">Selecione</option>
                                                <option value="solteiro(a)">Solteiro(a)</option>
                                                <option value="casado(a)">Casado(a)</option>
                                                <option value="divorciado(a)">Divorciado(a)</option>
                                                <option value="viúvo(a)">Viúvo(a)</option>
                                                <option value="união estável">União Estável</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="responsavel_nacionalidade" class="form-label">Nacionalidade</label>
                                            <input type="text" class="form-control" id="responsavel_nacionalidade" 
                                                   name="responsavel_nacionalidade" value="brasileira">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Coluna Direita - Dados do Contrato -->
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-file-contract me-2"></i>
                                    Dados do Contrato
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="tipo_plano" class="form-label">Tipo de Plano *</label>
                                            <select class="form-select" id="tipo_plano" name="tipo_plano" required>
                                                <option value="">Selecione o tipo</option>
                                                <option value="Aula Avulsa" data-valor="100.00" data-prazo="">Aula Avulsa - R$ 100/h</option>
                                                <option value="Aula Avulsa 1h30" data-valor="142.50" data-prazo="">Aula Avulsa - R$ 95/h</option>
                                                <option value="Aula Avulsa 2h" data-valor="180.00" data-prazo="">Aula Avulsa - R$ 90/h</option>
                                                <option value="Pacote 10 aulas" data-valor="950.00" data-prazo="6">Pacote 10 aulas - R$ 950 (6 meses)</option>
                                                <option value="Pacote 20 aulas" data-valor="1800.00" data-prazo="12">Pacote 20 aulas - R$ 1.800 (12 meses)</option>
                                                <option value="Pacote 30 aulas" data-valor="2550.00" data-prazo="12">Pacote 30 aulas - R$ 2.550 (12 meses)</option>
                                                <option value="Assinatura Gold" data-valor="680.00" data-prazo="">Assinatura Gold (1-8 aulas) - R$ 680/mês</option>
                                                <option value="Aula em Grupo 2 alunos" data-valor="65.00" data-prazo="">Aula em Grupo - R$ 65/h</option>
                                                <option value="Aula em Grupo 3 a 5 alunos" data-valor="50.00" data-prazo="">Aula em Grupo - R$ 50/h</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="valor_total" class="form-label">Valor Total *</label>
                                            <input type="number" class="form-control" id="valor_total" name="valor_total" 
                                                   step="0.01" min="0" required>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="data_inicio" class="form-label">Data de Início *</label>
                                            <input type="date" class="form-control" id="data_inicio" name="data_inicio" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="validade" class="form-label">Validade *</label>
                                            <input type="date" class="form-control" id="validade" name="validade" required>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="professor_id" class="form-label">Professor (Opcional)</label>
                                    <select class="form-select" id="professor_id" name="professor_id">
                                        <option value="">Selecione um professor</option>
                                        {% for professor in professores %}
                                        <option value="{{ professor.id }}">{{ professor.nome }} - {{ professor.disciplina }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="servicos_incluidos" class="form-label">Serviços Incluídos</label>
                                    <textarea class="form-control" id="servicos_incluidos" name="servicos_incluidos" 
                                              rows="3" placeholder="Descreva os serviços incluídos no contrato"></textarea>
                                </div>

                                <div class="mb-3">
                                    <label for="observacoes" class="form-label">Observações</label>
                                    <textarea class="form-control" id="observacoes" name="observacoes" 
                                              rows="3" placeholder="Observações adicionais"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seção de Alunos -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-graduation-cap me-2"></i>
                            Alunos do Contrato
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="alunos_container">
                            <p class="text-muted">Selecione um responsável primeiro</p>
                        </div>
                    </div>
                </div>

                <!-- Botões de Ação -->
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <button type="button" class="btn btn-outline-secondary" onclick="previewContrato()">
                                    <i class="fas fa-eye me-2"></i>
                                    Visualizar Prévia
                                </button>
                            </div>
                            <div>
                                <button type="button" class="btn btn-secondary me-2" onclick="salvarRascunho()">
                                    <i class="fas fa-save me-2"></i>
                                    Salvar Rascunho
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-file-pdf me-2"></i>
                                    Gerar Contrato
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Buscar Responsável -->
<div class="modal fade" id="modalBuscarResponsavel" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-search me-2"></i>
                    Buscar Responsável Existente
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" class="form-control" id="busca-responsavel" 
                           placeholder="Digite o nome, CPF ou telefone do responsável">
                </div>
                <div id="resultados-busca">
                    <!-- Resultados da busca serão inseridos aqui -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Prévia do Contrato -->
<div class="modal fade" id="modalPrevia" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>
                    Prévia do Contrato
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="conteudo-previa" style="max-height: 600px; overflow-y: auto;">
                    <!-- Conteúdo da prévia será inserido aqui -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="confirmarGeracao()">
                    <i class="fas fa-file-pdf me-2"></i>
                    Confirmar e Gerar PDF
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const responsavelSelect = document.getElementById('responsavel_select');
    const alunosContainer = document.getElementById('alunos_container');
    const tipoPlanoSelect = document.getElementById('tipo_plano');
    const valorTotalInput = document.getElementById('valor_total');
    const dataInicioInput = document.getElementById('data_inicio');
    const validadeInput = document.getElementById('validade');
    
    // Event listener para seleção de responsável
    responsavelSelect.addEventListener('change', function() {
        const responsavelId = this.value;
        
        if (responsavelId && responsavelId !== '0') {
            // Preencher dados do responsável
            const option = this.options[this.selectedIndex];
            document.getElementById('responsavel_nome').value = option.dataset.nome || '';
            document.getElementById('responsavel_cpf').value = option.dataset.cpf || '';
            document.getElementById('responsavel_rg').value = option.dataset.rg || '';
            document.getElementById('responsavel_telefone').value = option.dataset.telefone || '';
            document.getElementById('responsavel_email').value = option.dataset.email || '';
            document.getElementById('responsavel_endereco').value = option.dataset.endereco || '';
            document.getElementById('responsavel_estado_civil').value = option.dataset.estadoCivil || '';
            document.getElementById('responsavel_nacionalidade').value = option.dataset.nacionalidade || 'brasileira';
            
            // Buscar alunos do responsável via AJAX
            fetch(`/api/responsavel/${responsavelId}/alunos`)
                .then(response => response.json())
                .then(alunos => {
                    if (alunos.length > 0) {
                        let html = '<div class="form-check-container">';
                        html += '<p class="mb-3"><strong>Selecione os alunos para este contrato:</strong></p>';
                        alunos.forEach(aluno => {
                            html += `
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" 
                                           name="alunos_ids" value="${aluno.id}" 
                                           id="aluno_${aluno.id}">
                                    <label class="form-check-label" for="aluno_${aluno.id}">
                                        <strong>${aluno.nome}</strong><br>
                                        <small class="text-muted">Série: ${aluno.serie} | CPF: ${aluno.cpf}</small>
                                    </label>
                                </div>
                            `;
                        });
                        html += '</div>';
                        alunosContainer.innerHTML = html;
                    } else {
                        alunosContainer.innerHTML = '<p class="text-warning">Este responsável não possui filhos cadastrados.</p>';
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar alunos:', error);
                    alunosContainer.innerHTML = '<p class="text-danger">Erro ao carregar alunos.</p>';
                });
        } else {
            // Limpar campos do responsável
            document.getElementById('responsavel_nome').value = '';
            document.getElementById('responsavel_cpf').value = '';
            document.getElementById('responsavel_rg').value = '';
            document.getElementById('responsavel_telefone').value = '';
            document.getElementById('responsavel_email').value = '';
            document.getElementById('responsavel_endereco').value = '';
            document.getElementById('responsavel_estado_civil').value = '';
            document.getElementById('responsavel_nacionalidade').value = 'brasileira';
            
            alunosContainer.innerHTML = '<p class="text-muted">Selecione um responsável primeiro</p>';
        }
    });
    
    // Event listener para tipo de plano
    tipoPlanoSelect.addEventListener('change', function() {
        const option = this.options[this.selectedIndex];
        const valor = option.dataset.valor;
        const prazoMeses = option.dataset.prazo;
        
        if (valor) {
            valorTotalInput.value = valor;
        }
        
        // Calcular validade baseada no prazo
        if (prazoMeses && dataInicioInput.value) {
            const dataInicio = new Date(dataInicioInput.value);
            const novaValidade = new Date(dataInicio);
            novaValidade.setMonth(novaValidade.getMonth() + parseInt(prazoMeses));
            validadeInput.value = novaValidade.toISOString().split('T')[0];
        }
    });
    
    // Event listener para data de início
    dataInicioInput.addEventListener('change', function() {
        const tipoPlano = tipoPlanoSelect.value;
        const option = tipoPlanoSelect.options[tipoPlanoSelect.selectedIndex];
        const prazoMeses = option.dataset.prazo;
        
        if (prazoMeses) {
            const dataInicio = new Date(this.value);
            const novaValidade = new Date(dataInicio);
            novaValidade.setMonth(novaValidade.getMonth() + parseInt(prazoMeses));
            validadeInput.value = novaValidade.toISOString().split('T')[0];
        }
    });
    
    // Pré-preencher data de início com hoje
    if (dataInicioInput && !dataInicioInput.value) {
        const hoje = new Date().toISOString().split('T')[0];
        dataInicioInput.value = hoje;
    }
    
    // Pré-preencher validade com 1 ano a partir de hoje
    if (validadeInput && !validadeInput.value) {
        const umAnoDepois = new Date();
        umAnoDepois.setFullYear(umAnoDepois.getFullYear() + 1);
        validadeInput.value = umAnoDepois.toISOString().split('T')[0];
    }
    
    // Máscaras para campos
    aplicarMascaras();
});

function aplicarMascaras() {
    // Máscara para CPF
    const cpfInput = document.getElementById('responsavel_cpf');
    cpfInput.addEventListener('input', function() {
        let value = this.value.replace(/\D/g, '');
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        this.value = value;
    });
    
    // Máscara para telefone
    const telefoneInput = document.getElementById('responsavel_telefone');
    telefoneInput.addEventListener('input', function() {
        let value = this.value.replace(/\D/g, '');
        value = value.replace(/(\d{2})(\d)/, '($1) $2');
        value = value.replace(/(\d{5})(\d)/, '$1-$2');
        this.value = value;
    });
}

function limparFormulario() {
    if (confirm('Tem certeza que deseja limpar todos os campos?')) {
        document.getElementById('form-novo-contrato').reset();
        document.getElementById('responsavel_select').value = '0';
        document.getElementById('alunos_container').innerHTML = '<p class="text-muted">Selecione um responsável primeiro</p>';
        
        // Reconfigurar datas padrão
        const hoje = new Date().toISOString().split('T')[0];
        document.getElementById('data_inicio').value = hoje;
        
        const umAnoDepois = new Date();
        umAnoDepois.setFullYear(umAnoDepois.getFullYear() + 1);
        document.getElementById('validade').value = umAnoDepois.toISOString().split('T')[0];
    }
}

function buscarResponsavelExistente() {
    const modal = new bootstrap.Modal(document.getElementById('modalBuscarResponsavel'));
    modal.show();
    
    // Limpar busca anterior
    document.getElementById('busca-responsavel').value = '';
    document.getElementById('resultados-busca').innerHTML = '';
    
    // Event listener para busca
    document.getElementById('busca-responsavel').addEventListener('input', function() {
        const termo = this.value.trim();
        if (termo.length >= 3) {
            realizarBusca(termo);
        } else {
            document.getElementById('resultados-busca').innerHTML = '';
        }
    });
}

function realizarBusca(termo) {
    fetch(`/api/responsaveis/buscar?q=${encodeURIComponent(termo)}`)
        .then(response => response.json())
        .then(responsaveis => {
            let html = '';
            if (responsaveis.length > 0) {
                html = '<div class="list-group">';
                responsaveis.forEach(resp => {
                    html += `
                        <a href="#" class="list-group-item list-group-item-action" 
                           onclick="selecionarResponsavel(${resp.id}, '${resp.nome}', '${resp.cpf}', '${resp.rg}', '${resp.telefone}', '${resp.email}', '${resp.endereco}', '${resp.estado_civil}', '${resp.nacionalidade}')">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">${resp.nome}</h6>
                                <small>${resp.telefone}</small>
                            </div>
                            <p class="mb-1">CPF: ${resp.cpf}</p>
                            <small>E-mail: ${resp.email}</small>
                        </a>
                    `;
                });
                html += '</div>';
            } else {
                html = '<p class="text-muted">Nenhum responsável encontrado.</p>';
            }
            document.getElementById('resultados-busca').innerHTML = html;
        })
        .catch(error => {
            console.error('Erro na busca:', error);
            document.getElementById('resultados-busca').innerHTML = '<p class="text-danger">Erro ao realizar busca.</p>';
        });
}

function selecionarResponsavel(id, nome, cpf, rg, telefone, email, endereco, estadoCivil, nacionalidade) {
    // Fechar modal
    bootstrap.Modal.getInstance(document.getElementById('modalBuscarResponsavel')).hide();
    
    // Selecionar no dropdown
    document.getElementById('responsavel_select').value = id;
    
    // Preencher campos
    document.getElementById('responsavel_nome').value = nome;
    document.getElementById('responsavel_cpf').value = cpf;
    document.getElementById('responsavel_rg').value = rg;
    document.getElementById('responsavel_telefone').value = telefone;
    document.getElementById('responsavel_email').value = email;
    document.getElementById('responsavel_endereco').value = endereco;
    document.getElementById('responsavel_estado_civil').value = estadoCivil || '';
    document.getElementById('responsavel_nacionalidade').value = nacionalidade || 'brasileira';
    
    // Disparar evento de mudança para carregar alunos
    document.getElementById('responsavel_select').dispatchEvent(new Event('change'));
}

function previewContrato() {
    // Validar campos obrigatórios
    const form = document.getElementById('form-novo-contrato');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Coletar dados do formulário
    const dados = coletarDadosFormulario();
    
    // Gerar prévia
    const conteudoPrevia = gerarPreviaContrato(dados);
    document.getElementById('conteudo-previa').innerHTML = conteudoPrevia;
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('modalPrevia'));
    modal.show();
}

function coletarDadosFormulario() {
    const alunosSelecionados = [];
    document.querySelectorAll('input[name="alunos_ids"]:checked').forEach(checkbox => {
        const label = document.querySelector(`label[for="${checkbox.id}"]`);
        alunosSelecionados.push({
            id: checkbox.value,
            nome: label.querySelector('strong').textContent
        });
    });
    
    return {
        responsavel: {
            nome: document.getElementById('responsavel_nome').value,
            cpf: document.getElementById('responsavel_cpf').value,
            rg: document.getElementById('responsavel_rg').value,
            telefone: document.getElementById('responsavel_telefone').value,
            email: document.getElementById('responsavel_email').value,
            endereco: document.getElementById('responsavel_endereco').value,
            estado_civil: document.getElementById('responsavel_estado_civil').value,
            nacionalidade: document.getElementById('responsavel_nacionalidade').value
        },
        alunos: alunosSelecionados,
        contrato: {
            tipo_plano: document.getElementById('tipo_plano').value,
            valor_total: document.getElementById('valor_total').value,
            data_inicio: document.getElementById('data_inicio').value,
            validade: document.getElementById('validade').value,
            servicos_incluidos: document.getElementById('servicos_incluidos').value,
            observacoes: document.getElementById('observacoes').value
        }
    };
}

function gerarPreviaContrato(dados) {
    const alunosNomes = dados.alunos.map(a => a.nome).join(' e ');
    const dataInicio = new Date(dados.contrato.data_inicio).toLocaleDateString('pt-BR');
    const validade = new Date(dados.contrato.validade).toLocaleDateString('pt-BR');
    
    return `
        <div class="contract-preview">
            <h4 class="text-center mb-4">CONTRATO DE CONSUMO – AULA PARTICULAR</h4>
            <h5 class="text-center mb-4">ÍMPETUS INSTITUTO DE EDUCAÇÃO</h5>
            
            <p><strong>CONTRATADO:</strong> ÍMPETUS INSTITUTO DE EDUCAÇÃO</p>
            <p><strong>CONTRATANTE:</strong> ${dados.responsavel.nome}</p>
            <p><strong>CPF:</strong> ${dados.responsavel.cpf}</p>
            <p><strong>RG:</strong> ${dados.responsavel.rg}</p>
            <p><strong>Telefone:</strong> ${dados.responsavel.telefone}</p>
            <p><strong>E-mail:</strong> ${dados.responsavel.email}</p>
            <p><strong>Endereço:</strong> ${dados.responsavel.endereco}</p>
            
            <hr>
            
            <p><strong>Aluno(s):</strong> ${alunosNomes}</p>
            <p><strong>Tipo de Plano:</strong> ${dados.contrato.tipo_plano}</p>
            <p><strong>Valor Total:</strong> R$ ${parseFloat(dados.contrato.valor_total).toFixed(2).replace('.', ',')}</p>
            <p><strong>Data de Início:</strong> ${dataInicio}</p>
            <p><strong>Validade:</strong> ${validade}</p>
            
            ${dados.contrato.servicos_incluidos ? `<p><strong>Serviços Incluídos:</strong> ${dados.contrato.servicos_incluidos}</p>` : ''}
            ${dados.contrato.observacoes ? `<p><strong>Observações:</strong> ${dados.contrato.observacoes}</p>` : ''}
        </div>
    `;
}

function confirmarGeracao() {
    // Fechar modal de prévia
    bootstrap.Modal.getInstance(document.getElementById('modalPrevia')).hide();
    
    // Submeter formulário
    document.getElementById('form-novo-contrato').submit();
}

function salvarRascunho() {
    const dados = coletarDadosFormulario();
    
    fetch('/contratos/rascunho', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(dados)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Rascunho salvo com sucesso!');
        } else {
            alert('Erro ao salvar rascunho: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao salvar rascunho');
    });
}
</script>

<style>
.form-check-container {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
}

.contract-preview {
    font-family: 'Times New Roman', serif;
    line-height: 1.6;
}

.contract-preview h4, .contract-preview h5 {
    font-weight: bold;
}

.contract-preview p {
    margin-bottom: 0.5rem;
}

.contract-preview hr {
    margin: 1.5rem 0;
}
</style>
{% endblock %}